# 时间点恢复 - 时间格式使用说明

## 概述

在实际使用时间点恢复功能时，您需要指定要恢复到的目标时间点。本文档说明应该使用什么格式的时间。

## 推荐方式：使用东8区（Asia/Shanghai）本地时间

### 格式要求

**时间格式**：`YYYY-MM-DD HH:MM:SS`

**时区**：东8区（Asia/Shanghai）本地时间

**示例**：
```bash
# 恢复到 2025-11-27 18:23:10（东8区时间）
# 使用统一入口（推荐）
docker-compose run --rm \
  -e RESTORE_TZ="Asia/Shanghai" \
  mysql python3 /scripts/main.py restore pitr "2025-11-27 18:23:10"

# 或直接调用 Python 脚本
docker-compose run --rm \
  -e RESTORE_TZ="Asia/Shanghai" \
  mysql python3 /scripts/tasks/restore/point_in_time_restore.py "2025-11-27 18:23:10"
```

### 为什么使用本地时间？

1. **符合使用习惯**：数据库时间使用东8区，业务人员也习惯使用东8区时间
2. **脚本自动处理**：恢复脚本会自动将本地时间转换为 UTC 时间传给 `mysqlbinlog`
3. **避免时区混淆**：不需要手动计算 UTC 时间

### 使用方法

#### 方法 1：使用统一入口（推荐）

```bash
# 设置时区环境变量（可选，默认就是 Asia/Shanghai）
export RESTORE_TZ='Asia/Shanghai'

# 执行恢复，使用东8区时间
docker-compose run --rm \
  -e RESTORE_TZ="Asia/Shanghai" \
  mysql python3 /scripts/main.py restore pitr "2025-11-27 18:23:10"
```

#### 方法 2：直接调用 Python 脚本

```bash
docker-compose run --rm \
  -e RESTORE_TZ="Asia/Shanghai" \
  mysql python3 /scripts/tasks/restore/point_in_time_restore.py "2025-11-27 18:23:10"
```

#### 方法 3：通过 Docker 环境变量

```bash
docker run --rm \
  -e MYSQL_ROOT_PASSWORD="your_password" \
  -e RESTORE_TZ="Asia/Shanghai" \
  -v /path/to/mysql_data:/var/lib/mysql \
  -v /path/to/backups:/backups \
  --entrypoint /bin/bash \
  your_image:tag \
  -c "python3 /scripts/tasks/restore/point_in_time_restore.py \"2025-11-27 18:23:10\""
```

## 脚本内部处理流程

恢复脚本会按以下步骤处理时间：

1. **接收本地时间**：您传入 `"2025-11-27 18:23:10"`（东8区）
2. **转换为时间戳**：使用 `RESTORE_TZ` 时区将时间字符串转换为 epoch 时间戳
3. **转换为 UTC**：将时间戳转换为 UTC 时间字符串
4. **传给 mysqlbinlog**：使用 UTC 时间调用 `mysqlbinlog --stop-datetime`

### 代码示例

```bash
# 脚本内部处理（简化版）
RESTORE_TZ=${RESTORE_TZ:-Asia/Shanghai}
export TZ="$RESTORE_TZ"

# 1. 将本地时间转换为时间戳
target_timestamp=$(TZ="$RESTORE_TZ" date -d "$target_datetime" +%s)

# 2. 加1秒（确保包含边界数据）
stop_timestamp=$((target_timestamp + 1))

# 3. 转换为 UTC 时间字符串
stop_datetime_utc=$(TZ=UTC date -d "@$stop_timestamp" "+%Y-%m-%d %H:%M:%S")

# 4. 使用 UTC 时间调用 mysqlbinlog
mysqlbinlog --stop-datetime="$stop_datetime_utc" ...
```

## 时间格式示例

### 正确格式

```bash
# ✅ 标准格式
"2025-11-27 18:23:10"

# ✅ 使用统一入口（推荐）
docker-compose run --rm \
  -e RESTORE_TZ="Asia/Shanghai" \
  mysql python3 /scripts/main.py restore pitr "2025-11-27 18:23:10"

# ✅ 使用变量
TARGET_TIME="2025-11-27 18:23:10"
docker-compose run --rm \
  -e RESTORE_TZ="Asia/Shanghai" \
  mysql python3 /scripts/main.py restore pitr "$TARGET_TIME"
```

### 错误格式

```bash
# ❌ 缺少引号（空格会导致参数解析错误）
docker-compose run --rm mysql python3 /scripts/main.py restore pitr 2025-11-27 18:23:10

# ❌ 使用 UTC 时间（不推荐，容易混淆）
docker-compose run --rm \
  -e RESTORE_TZ="Asia/Shanghai" \
  mysql python3 /scripts/main.py restore pitr "2025-11-27 10:23:10"  # 这是 UTC 时间，不是东8区

# ❌ 格式不正确
docker-compose run --rm \
  -e RESTORE_TZ="Asia/Shanghai" \
  mysql python3 /scripts/main.py restore pitr "2025/11/27 18:23:10"  # 日期分隔符错误
docker-compose run --rm \
  -e RESTORE_TZ="Asia/Shanghai" \
  mysql python3 /scripts/main.py restore pitr "2025-11-27T18:23:10"  # ISO 格式，不支持
```

## 如何确定要恢复的时间点？

### 方法 1：从业务日志中查找

```bash
# 查看业务日志，找到误操作发生的时间
# 例如：2025-11-27 18:23:10 发生了误删除操作
# 那么应该恢复到 2025-11-27 18:23:10 之前
docker-compose run --rm \
  -e RESTORE_TZ="Asia/Shanghai" \
  mysql python3 /scripts/main.py restore pitr "2025-11-27 18:23:09"
```

### 方法 2：从数据库日志中查找

```bash
# 查看 MySQL 错误日志或慢查询日志
# 找到误操作的时间点
```

### 方法 3：使用 binlog 查看

```bash
# 查看 binlog 中的时间戳
mysqlbinlog /path/to/mysql-bin.000001 | grep "SET TIMESTAMP"

# 找到误操作的时间戳，转换为本地时间
# 例如：SET TIMESTAMP=1764267790
# 转换为东8区时间：
date -d "@1764267790" '+%Y-%m-%d %H:%M:%S'
# 输出：2025-11-27 18:23:10
```

## 注意事项

### 1. 时区环境变量

如果您的系统时区不是 Asia/Shanghai，建议显式设置：

```bash
export RESTORE_TZ='Asia/Shanghai'
```

### 2. 时间精度

- **支持精度**：秒级（`HH:MM:SS`）
- **边界处理**：脚本会自动加 1 秒，确保包含目标时间点的数据
- **建议**：如果误操作发生在 `18:23:10`，可以恢复到 `18:23:10` 或 `18:23:09`

### 3. 时间范围

确保目标时间点在：
- **最早**：最后一次全量备份的时间之后
- **最晚**：当前时间之前

### 4. 夏令时

东8区（Asia/Shanghai）不使用夏令时，所以不需要考虑夏令时问题。

## 完整使用示例

```bash
#!/bin/bash

# 设置环境变量
export RESTORE_TZ='Asia/Shanghai'
export MYSQL_ROOT_PASSWORD='your_password'

# 停止 MySQL（如果正在运行）
docker-compose stop mysql

# 执行时间点恢复
# 恢复到 2025-11-27 18:23:10（东8区时间）
docker-compose run --rm \
  -e RESTORE_TZ="$RESTORE_TZ" \
  mysql python3 /scripts/main.py restore pitr "2025-11-27 18:23:10"

# 启动 MySQL
docker-compose up -d mysql

# 验证恢复结果
docker exec mysql_container mysql -u root -p"$MYSQL_ROOT_PASSWORD" -e "SELECT COUNT(*) FROM your_table;"
```

## 常见问题

### Q1: 我可以使用 UTC 时间吗？

**A**: 可以，但不推荐。如果您使用 UTC 时间，需要：
1. 设置 `RESTORE_TZ=UTC`
2. 传入 UTC 时间字符串

```bash
export RESTORE_TZ='UTC'
docker-compose run --rm \
  -e RESTORE_TZ="UTC" \
  mysql python3 /scripts/main.py restore pitr "2025-11-27 10:23:10"  # UTC 时间
```

但这样容易混淆，因为数据库时间显示的是东8区。

### Q2: 时间格式可以更精确吗（到毫秒）？

**A**: 目前不支持。脚本只支持秒级精度。如果需要更精确，可以：
1. 恢复到目标时间的前一秒
2. 然后手动应用部分 binlog

### Q3: 如何验证恢复的时间点是否正确？

**A**: 恢复后，检查数据：

```bash
# 查看恢复后的数据时间戳
docker exec mysql_container mysql -u root -p"$MYSQL_ROOT_PASSWORD" \
  -e "SELECT MAX(updated_at) FROM your_table;"

# 应该接近（但不晚于）您指定的恢复时间点
```

### Q4: 恢复时间点可以精确到秒吗？

**A**: 可以。脚本支持秒级精度。例如：
```bash
docker-compose run --rm \
  -e RESTORE_TZ="Asia/Shanghai" \
  mysql python3 /scripts/main.py restore pitr "2025-11-27 18:23:10"
```

会恢复到 `18:23:10` 这一秒结束时的状态（包含 `18:23:10` 这一秒的所有数据）。

## 总结

**推荐做法**：
1. ✅ 使用东8区（Asia/Shanghai）本地时间
2. ✅ 格式：`YYYY-MM-DD HH:MM:SS`
3. ✅ 使用引号包裹时间字符串
4. ✅ 设置 `RESTORE_TZ=Asia/Shanghai` 环境变量（可选，默认就是）

**示例**：
```bash
docker-compose run --rm \
  -e RESTORE_TZ="Asia/Shanghai" \
  mysql python3 /scripts/main.py restore pitr "2025-11-27 18:23:10"
```

脚本会自动处理时区转换，您只需要使用熟悉的本地时间即可。

---

**最后更新**：2025-11-27  
**适用版本**：point_in_time_restore.py v1.0+（Python 版本）

