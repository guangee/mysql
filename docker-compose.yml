version: '3.8'

services:
  mysql:
    build:
      context: .
    container_name: mysql8044
    restart: unless-stopped
    environment:
      # MySQL 配置
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-testdb}
      MYSQL_USER: ${MYSQL_USER:-testuser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-testpass}
      
      # S3 兼容对象存储配置
      S3_BACKUP_ENABLED: ${S3_BACKUP_ENABLED:-true}
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET:-mysql-backups}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_USE_SSL: ${S3_USE_SSL:-true}
      S3_FORCE_PATH_STYLE: ${S3_FORCE_PATH_STYLE:-false}
      S3_ALIAS: ${S3_ALIAS:-s3}
      
      # 备份配置
      BACKUP_BASE_DIR: /backups
      FULL_BACKUP_SCHEDULE: ${FULL_BACKUP_SCHEDULE:-0 2 * * 0}
      INCREMENTAL_BACKUP_SCHEDULE: ${INCREMENTAL_BACKUP_SCHEDULE:-0 3 * * *}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}
      LOCAL_BACKUP_RETENTION_HOURS: ${LOCAL_BACKUP_RETENTION_HOURS:-0}
    volumes:
      - ./mysql_data:/var/lib/mysql
      - ./mysql_config:/etc/mysql/conf.d
      - ./backups:/backups
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    networks:
      - backup-network
    entrypoint: ["/usr/local/bin/docker-entrypoint-with-backup.sh"]
    command:
      # 将mysql8.0默认密码策略 修改为 原先 策略 (mysql8.0对其默认策略做了更改 会导致密码无法匹配)
      --default-authentication-plugin=mysql_native_password
      --log-bin=mysql-bin
      --server-id=1
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_general_ci
      --explicit_defaults_for_timestamp=true
      --lower_case_table_names=1

networks:
  backup-network:
    driver: bridge
